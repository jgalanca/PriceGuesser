name: iOS CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Display Xcode Version
      run: xcodebuild -version
    
    - name: Display Swift Version
      run: swift --version
    
    - name: Create Secrets.xcconfig
      run: |
        cat > Configuration/Secrets.xcconfig << EOF
        PRODUCT_NAME = PriceGuesser
        PRODUCT_BUNDLE_IDENTIFIER = com.example.PriceGuesser.ci
        DEVELOPMENT_TEAM = 
        CODE_SIGN_IDENTITY = 
        PROVISIONING_PROFILE_SPECIFIER = 
        EOF
        echo "âœ… Secrets.xcconfig created for CI"
      
    - name: Build
      run: |
        xcodebuild clean build \
          -project PriceGuesser.xcodeproj \
          -scheme PriceGuesser \
          -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Run Tests
      run: |
        xcodebuild test \
          -project PriceGuesser.xcodeproj \
          -scheme PriceGuesser \
          -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
          -derivedDataPath ./DerivedData \
          -enableCodeCoverage YES \
          -resultBundlePath ./TestResults.xcresult \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Generate Coverage Report
      if: always()
      run: |
        xcrun xccov view --report --json ./TestResults.xcresult > coverage.json
        echo "ðŸ“Š Coverage report generated"
      continue-on-error: true
    
    - name: Upload Coverage Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.json
        if-no-files-found: warn
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ./TestResults.xcresult
        if-no-files-found: warn
    
    - name: Archive Build Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ./DerivedData/Logs/
          ~/Library/Logs/DiagnosticReports/
        if-no-files-found: warn

  swiftlint:
    name: SwiftLint Analysis
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install SwiftLint
      run: brew install swiftlint
      
    - name: Run SwiftLint (Strict Mode)
      run: swiftlint lint --strict --reporter github-actions-logging